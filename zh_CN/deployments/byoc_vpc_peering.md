# 在 BYOC 中设置 VPC 对等连接

VPC 对等连接是两个 VPC 之间的网络连接，通过此连接，使两个 VPC 中的实例可以彼此通信，就像它们在同一网络中一样。如果您需要和 EMQX Cloud BYOC 部署下的 EMQX 集群通过内网进行数据交换，您需要对部署所在的 VPC 和您的其他 VPC 进行对等连接配置。

## 注意事项

1. EMQX Cloud 只支持在**同一区域内**创建对等连接。
2. EMQX Cloud 不接收 `10.10.0.0/24 ～ 10.64.255.0/24` 范围内的网段，请合理规划您的 VPC 网段。
3. 数据集成创建资源前请先创建对等连接。

## 亚马逊云平台对等连接

### 创建对等连接

1. 登录亚马逊云控制台，切换区域到 BYOC **部署所在区域**，进入**联网** -> **VPC** -> **对等连接**，点击右上方的**创建对等连接**。

    * 为此对等连接设置一个名称（可选）
    * 在 VPC ID (请求者)处，选择 BYOC 部署所在的 VPC，VPC 名称格式为 `emqxbyoc-XXXX-vpc`
    * 记录下请求者 **VPC CIDR 网段**，后面的步骤用将会用到此信息
    * 在账户处选择**我的账户**
    * 在区域处选择**此区域**
    * 在 VPC ID (接受方)处，选择您要与 BYOC 部署进行数据交换的系统所在的 VPC
    * 记录下接受方 **VPC CIDR 网段**，后面的步骤用将会用到此信息

    ![BYOC VPC Peering on AWS](_assets/byoc_vpc_peering_aws.png)

2. 点击创建后，需点击**操作**中的**接受请求**。一旦完成创建，如下图所示。请记录下以 `pcx-` 开头的**对等连接 ID**，后面的步骤用将会用到此信息。

### 创建路由和安全组规则

::: tip
以下内容中涉及到的名词解释:
- 请求者 VPC : BYOC 部署所在的 VPC
- 接受方 VPC : 需要与 BYOC 部署进行数据交换的系统所在的 VPC
:::

#### 请求者 VPC

1. 在亚马逊云控制台，进入**联网** -> **VPC** -> **路由表**，找到请求者 BYOC 的 VPC 路由表（名称通常是 `emqxbyoc-xxxx-private-route-table`），点击编辑路由。
2. 点击 添加路由，将上一步记录下的接受方 **VPC CIDR 网段**填入左侧目标，将以 `pcx-` 开头的**对等连接 ID**填入右侧目标。

    ![add-route-table](./_assets/byoc_add_aws_cn_route_tables.png)

3. 找到**联网** -> **VPC** -> **安全组**，找到绑定在请求者 VPC 上的安全组，在入站规则中添加接受方 **VPC CIDR 网段**，允许其所有 TCP 流量。


#### 接收方 VPC

1. 在亚马逊云控制台，进入**联网** -> **VPC** -> **路由表**，找到接收方的 VPC 路由表，点击编辑路由。
2. 点击 添加路由，将上一步记录下的请求者 BYOC **VPC CIDR 网段**填入左侧目标，将以 `pcx-` 开头的**对等连接 ID** 填入右侧目标。
3. 找到**联网** -> **VPC** -> **安全组**，找到绑定在接收方 VPC 上的安全组，在入站规则中添加请求者 BYOC **VPC CIDR 网段**，允许其所有 TCP 流量。
