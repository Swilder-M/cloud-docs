# 使用 EMQX Cloud 数据集成消息重新发布

当有消息满足某一特征时，你希望在不编写代码的情况下，将它发布到其它主题上。可以通过 EMQX Cloud 数据集成 —— 消息重新发布，轻松实现这一功能。

这篇指南会完成一个 `消息重新发布` 数据集成的创建，实现下面的目标：

**当任一消息的 msg 包含 'hello' 字符串时，将消息转发到 greet 主题**

为了实现这个功能，我们会依次完成以下 3 个任务：

1. 设置数据集成的筛选条件
2. 创建一个动作
3. 完成数据集成创建，并进行测试


## 1. 设置数据集成的筛选条件

在数据集成 - 创建页面中，选择`消息重新发布`，并点击创建。如果您已经创建了其他的连接器，选择**新建连接器**，然后在 ‘数据转发’ 服务分类下选择‘消息重新发布’。


我们的目标是：任何消息中，只要 msg 中包含 'hello' 字符串，就会触发引擎。这里需要对 SQL 进行一定的处理：

* 针对所有的主题，即 '#'
* 对 payload 中的 msg 进行正则匹配，含有 'hello' 字符串再执行数据集成

根据上面的原则，我们最后得到的 SQL 应该如下：

```sql
SELECT
  payload.msg as msg
FROM
  "#"
WHERE  
  regex_match(msg, 'hello')
```
可以点击 SQL 输入框下的 SQL 测试 ，填写数据：

* topic: t/a
* payload:
  ```json
  {
    "msg":"hello test"
  }
  ```
点击测试，查看得到的数据结果，如果设置无误，测试输出框应该得到完整的 JSON 数据，如下：

```json
{
  "msg":"hello test"
}
```

测试输出与预期相符，我们可以进行后续步骤。
>注意：如果无法通过测试，请检查 SQL 是否合规


## 2. 创建动作

点击`下一步`，添加动作。

在动作页面中，目标主题设为 greet，在消息内容模板里填写 "${msg} -- forward from emqx cloud"，QoS 默认。点击确定完成配置。


## 3. 测试

1. 我们推荐使用 [MQTTX](https://mqttx.app/) 模拟消息上报，同时您也可以使用其他任意客户端完成。我们使用 MQTTX 连接到部署，并向 test 主题发送消息。

```json
{
  "msg": "hello"
}
```

2. 消息重新发布无需添加任何连接器。我们在规则列表中，我们可以看到消息重新发布的规则。点击规则 ID，在规则统计页面中，可以看到相关的统计指标。
![重新发布](./_assets/republish_01.png)

3. 客户端订阅 greet 主题，可以看到如果 `msg`包含 ‘hello’，消息将被转发，如果不包含，则不会转发。
![重新发布](./_assets/republish_02.png)
